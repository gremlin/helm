suite: Test gremlin TLS identity secret
templates:
  - secret-gremlin-tls-identity.yaml
release:
  name: my-release
  namespace: my-namespace
  revision: 1
  upgrade: true
tests:
  - it: should not create a secret when tls identity is not enabled
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create a secret when enabled but no cert/key provided
    set:
      gremlin.tls.identity.enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should create a secret when createSecret strategy is fully configured
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.createSecret.name: gremlin-tls-identity
      gremlin.tls.identity.createSecret.cert: |
        -----BEGIN CERTIFICATE-----
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        11111111111111111111111111111111111111111111111111==
        -----END CERTIFICATE-----
      gremlin.tls.identity.createSecret.key:
        -----BEGIN PRIVATE KEY-----
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        11111111111111111111111111111111111111111111111111==
        -----END PRIVATE KEY-----
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: gremlin-tls-identity
      - equal:
          path: metadata.namespace
          value: my-namespace
      - equal:
          path: type
          value: kubernetes.io/Opaque

  - it: should use a custom secret name when specified
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.createSecret.name: my-custom-tls-secret
      gremlin.tls.identity.createSecret.cert: "dummy-cert"
      gremlin.tls.identity.createSecret.key: "dummy-key"
    asserts:
      - equal:
          path: metadata.name
          value: my-custom-tls-secret

  - it: should not create a secret when remoteSecret strategy is used
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.remoteSecret.cert: "arn:aws:secretsmanager:us-east-1:123456789:secret:cert"
      gremlin.tls.identity.remoteSecret.key: "arn:aws:secretsmanager:us-east-1:123456789:secret:key"
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create a secret when identity is disabled even with createSecret values
    set:
      gremlin.tls.identity.enabled: false
      gremlin.tls.identity.createSecret.name: my-custom-tls-secret
      gremlin.tls.identity.createSecret.cert: "dummy-cert"
      gremlin.tls.identity.createSecret.key: "dummy-key"
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create a secret when existingSecret strategy is used
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.existingSecret.name: my-existing-secret
    asserts:
      - hasDocuments:
          count: 0
