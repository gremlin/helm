suite: "Gremlin Integrations Deployment TLS Identity Tests"
templates:
  - "templates/deployment.yaml"

tests:
  # gremlin.tls.identity tests

  - it: should not include TLS identity env vars when tls identity is not enabled
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: GREMLIN_TLS_IDENTITY_CERTIFICATE
          any: true
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: GREMLIN_TLS_IDENTITY_PRIVATE_KEY
          any: true

  - it: should set TLS identity env vars to ARN values when remoteSecret is configured
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.remoteSecret.cert: "arn:aws:secretsmanager:us-east-1:123456789:secret:cert"
      gremlin.tls.identity.remoteSecret.key: "arn:aws:secretsmanager:us-east-1:123456789:secret:key"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GREMLIN_TLS_IDENTITY_CERTIFICATE
            value: "arn:aws:secretsmanager:us-east-1:123456789:secret:cert"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GREMLIN_TLS_IDENTITY_PRIVATE_KEY
            value: "arn:aws:secretsmanager:us-east-1:123456789:secret:key"

  - it: should not mount TLS identity volumes when remoteSecret is configured
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.remoteSecret.cert: "arn:aws:secretsmanager:us-east-1:123456789:secret:cert"
      gremlin.tls.identity.remoteSecret.key: "arn:aws:secretsmanager:us-east-1:123456789:secret:key"
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: gremlin-tls-identity
            mountPath: /var/lib/gremlin/tls/identity
            readOnly: true
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: gremlin-tls-identity
          any: true

  - it: should set TLS identity env vars to file paths when createSecret is configured
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.createSecret.name: gremlin-tls-identity
      gremlin.tls.identity.createSecret.cert: |
        -----BEGIN CERTIFICATE-----
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        11111111111111111111111111111111111111111111111111==
        -----END CERTIFICATE-----
      gremlin.tls.identity.createSecret.key:
        -----BEGIN PRIVATE KEY-----
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        11111111111111111111111111111111111111111111111111==
        -----END PRIVATE KEY-----
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GREMLIN_TLS_IDENTITY_CERTIFICATE
            value: /var/lib/gremlin/tls/identity/cert
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GREMLIN_TLS_IDENTITY_PRIVATE_KEY
            value: /var/lib/gremlin/tls/identity/key

  - it: should mount TLS identity volume when createSecret is configured
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.createSecret.name: gremlin-tls-identity
      gremlin.tls.identity.createSecret.cert: |
        -----BEGIN CERTIFICATE-----
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        11111111111111111111111111111111111111111111111111==
        -----END CERTIFICATE-----
      gremlin.tls.identity.createSecret.key:
        -----BEGIN PRIVATE KEY-----
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        1111111111111111111111111111111111111111111111111111111111111111
        11111111111111111111111111111111111111111111111111==
        -----END PRIVATE KEY-----
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: gremlin-tls-identity
            mountPath: /var/lib/gremlin/tls/identity
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: gremlin-tls-identity
            secret:
              secretName: gremlin-tls-identity

  - it: should set TLS identity env vars to file paths when existingSecret is configured
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.existingSecret.name: my-existing-secret
      gremlin.tls.identity.existingSecret.cert: tls.crt
      gremlin.tls.identity.existingSecret.key: tls.key
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GREMLIN_TLS_IDENTITY_CERTIFICATE
            value: /var/lib/gremlin/tls/identity/tls.crt
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GREMLIN_TLS_IDENTITY_PRIVATE_KEY
            value: /var/lib/gremlin/tls/identity/tls.key

  - it: should set TLS identity env vars to file paths when existingSecret is customized
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.existingSecret.name: my-existing-secret
      gremlin.tls.identity.existingSecret.cert: custom.crt
      gremlin.tls.identity.existingSecret.key: custom.key
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GREMLIN_TLS_IDENTITY_CERTIFICATE
            value: /var/lib/gremlin/tls/identity/custom.crt
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GREMLIN_TLS_IDENTITY_PRIVATE_KEY
            value: /var/lib/gremlin/tls/identity/custom.key

  - it: should mount TLS identity volume from existingSecret when configured
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.existingSecret.name: my-existing-secret
      gremlin.tls.identity.existingSecret.cert: tls.crt
      gremlin.tls.identity.existingSecret.key: tls.key
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: gremlin-tls-identity
            mountPath: /var/lib/gremlin/tls/identity
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: gremlin-tls-identity
            secret:
              secretName: my-existing-secret

  - it: should fail when multiple TLS identity strategies are configured for gremlin
    set:
      gremlin.tls.identity.enabled: true
      gremlin.tls.identity.remoteSecret.cert: "arn:aws:secretsmanager:us-east-1:123456789:secret:cert"
      gremlin.tls.identity.remoteSecret.key: "arn:aws:secretsmanager:us-east-1:123456789:secret:key"
      gremlin.tls.identity.createSecret.name: gremlin-tls-identity
      gremlin.tls.identity.createSecret.cert: "dummy-cert"
      gremlin.tls.identity.createSecret.key: "dummy-key"
    asserts:
      - failedTemplate:
          errorMessage: "gremlin.tls.identity: only one of remoteSecret, createSecret, or existingSecret should be fully configured"
